# default test
## install flume-ng in cloudera
telnet 127.0.0.1 9999
cat /var/log/flume-ng/flume-cmf-flume-AGENT-node0.log

# netcat to hdfs
tier1.sources  = source1
tier1.channels = channel1
tier1.sinks    = sink1

tier1.sources.source1.type     = netcat
tier1.sources.source1.bind     = 127.0.0.1
tier1.sources.source1.port     = 9999
tier1.sources.source1.channels = channel1
tier1.channels.channel1.type   = memory
tier1.sinks.sink1.type         = hdfs
tier1.sinks.sink1.fileType     = DataStream
tier1.sinks.sink1.channel      = channel1
tier1.sinks.sink1.hdfs.path    = hdfs://node0:8020/tmp

tier1.channels.channel1.capacity = 100

# spooldir to hdfs
mkdir -p /tmp/flume/spooldirTest
chmod -R 777 /tmp/flume/

tier1.sources  = source1
tier1.channels = channel1
tier1.sinks    = sink1

tier1.sources.source1.type     = spooldir
tier1.sources.source1.spoolDir = /tmp/flume/spooldirTest
tier1.sources.source1.channels = channel1
tier1.channels.channel1.type   = memory
tier1.sinks.sink1.type         = hdfs
tier1.sinks.sink1.fileType     = DataStream
tier1.sinks.sink1.channel      = channel1
tier1.sinks.sink1.hdfs.path    = hdfs://node0:8020/tmp

tier1.channels.channel1.capacity = 100

# spooldir to org.apache.flume.sink.solr.morphline.MorphlineSolrSink
mkdir -p /tmp/flume/morphlineSolrSinkTest
chmod -R 777 /tmp/flume/


solrctl --zk 192.168.1.200:2181/solr instancedir --generate /tmp/solr_configs
solrctl --zk 192.168.1.200:2181/solr instancedir --create morphlineSolrSinkCollection /tmp/solr_configs
solrctl --zk 192.168.1.200:2181/solr instancedir --list 
solrctl --zk 192.168.1.200:2181/solr collection --create morphlineSolrSinkCollection -s 1 -c morphlineSolrSinkCollection


vi /tmp/flume/morphlineSolrSinkTest/data_0.json
{"docId":10,"links":{"backward":[],"forward":[20,40,60,true,false,32767,2147483647,9223372036854775807,1.23,1.7976931348623157E308],"bool":true,"short":32767,"int":2147483647,"long":9223372036854775807,"double":1.7976931348623157E308},"name":[{"language":[{"code":"en-us","country":"us"},{"code":"en","country":null}],"url":"http:\/\/A"},{"language":[],"url":"http:\/\/B"},{"language":[{"code":"en-gb","country":"gb"}],"url":null}]}


vi /tmp/morphlineSolrSinkTest
SOLR_LOCATOR : {
  collection : morphlineSolrSinkCollection
  zkHost : "node0:2181/solr"
}
morphlines : [
  {
    id : morphline_0
    importCommands : ["org.kitesdk.**", "org.apache.solr.**"]
    commands : [                    
      { 
        readJson {}
      } 
      { extractJsonPaths {
          flatten : true
          paths : { 
            "id" : "/docId"
            "bool" : "/links/bool"
            "short" : "/links/short"
            "int" : "/links/int"
            "long" : "/links/long"
            "double" : "/links/double"
            "name_languages_codes" : "/name[]/language[]/code"
            "name_language_countries" : "/name[]/language[]/country"
            "name_urls" : "/name[]/url"
          } 
        }
      }
      {
        sanitizeUnknownSolrFields {
          solrLocator : ${SOLR_LOCATOR}
        }
      }
      { logInfo { format : "output record: {}", args : ["@{}"] } }
      {
        loadSolr {
          solrLocator : ${SOLR_LOCATOR}
        }
      }  
    ]
  }
]


tier1.sources  = source1
tier1.channels = channel1
tier1.sinks    = sink1

tier1.sources.source1.type     = spooldir
tier1.sources.source1.spoolDir = /tmp/flume/morphlineSolrSinkTest
tier1.sources.source1.channels = channel1
tier1.channels.channel1.type   = memory
tier1.sinks.sink1.type         = org.apache.flume.sink.solr.morphline.MorphlineSolrSink
tier1.sinks.sink1.channel      = channel1
tier1.sinks.sink1.morphlineFile    = /tmp/morphlineSolrSinkTest

tier1.channels.channel1.capacity = 100

